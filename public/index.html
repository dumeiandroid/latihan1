<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D1 CRUD Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">D1 Database CRUD Test</h1>
        
        <!-- Debug Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Debug Panel</h5>
            </div>
            <div class="card-body">
                <pre id="debug" class="bg-light p-2 small" style="max-height: 200px; overflow-y: auto;"></pre>
                <button class="btn btn-sm btn-secondary" onclick="clearDebug()">Clear Debug</button>
            </div>
        </div>

        <!-- Add User Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Add New User</h5>
            </div>
            <div class="card-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="row">
                        <div class="col-md-5">
                            <input type="text" class="form-control" id="userName" placeholder="Name" required>
                        </div>
                        <div class="col-md-5">
                            <input type="email" class="form-control" id="userEmail" placeholder="Email" required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100" id="submitBtn">Add</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Users List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <h5>Users</h5>
                <button class="btn btn-sm btn-success" onclick="loadUsers()">Refresh</button>
            </div>
            <div class="card-body">
                <div id="loading" class="text-center">Loading...</div>
                <div id="usersList"></div>
            </div>
        </div>
    </div>

    <script>
        let isEditing = false;

        function debug(message) {
            const debugEl = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            debugEl.textContent += `[${timestamp}] ${message}\n`;
            debugEl.scrollTop = debugEl.scrollHeight;
            console.log(message);
        }

        function clearDebug() {
            document.getElementById('debug').textContent = '';
        }

        async function loadUsers() {
            debug('Loading users...');
            try {
                const response = await fetch('/api/users');
                const result = await response.json();
                
                if (result.success) {
                    displayUsers(result.data);
                    debug(`Loaded ${result.data.length} users`);
                } else {
                    debug(`Error loading users: ${result.error}`);
                    alert('Error loading users: ' + result.error);
                }
            } catch (error) {
                debug(`Fetch error: ${error.message}`);
                alert('Network error: ' + error.message);
            }
            document.getElementById('loading').style.display = 'none';
        }

        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            if (users.length === 0) {
                usersList.innerHTML = '<p class="text-muted">No users found</p>';
                return;
            }

            usersList.innerHTML = users.map(user => `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-md-3"><strong>${user.name}</strong></div>
                            <div class="col-md-4">${user.email}</div>
                            <div class="col-md-3 small text-muted">${new Date(user.created_at).toLocaleString()}</div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-warning me-1" onclick="editUser(${user.id}, '${user.name}', '${user.email}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editUser(id, name, email) {
            document.getElementById('userId').value = id;
            document.getElementById('userName').value = name;
            document.getElementById('userEmail').value = email;
            document.getElementById('submitBtn').textContent = 'Update';
            isEditing = true;
            debug(`Editing user ID: ${id}`);
        }

        function resetForm() {
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('submitBtn').textContent = 'Add';
            isEditing = false;
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            debug(`Deleting user ID: ${id}`);
            try {
                const response = await fetch(`/api/users/${id}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    debug('User deleted successfully');
                    loadUsers();
                } else {
                    debug(`Delete error: ${result.error}`);
                    alert('Error deleting user: ' + result.error);
                }
            } catch (error) {
                debug(`Delete fetch error: ${error.message}`);
                alert('Network error: ' + error.message);
            }
        }

        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            
            if (!name || !email) {
                alert('Please fill in all fields');
                return;
            }

            debug(`${isEditing ? 'Updating' : 'Adding'} user: ${name} (${email})`);
            
            try {
                const url = isEditing ? `/api/users/${document.getElementById('userId').value}` : '/api/users';
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    debug(`User ${isEditing ? 'updated' : 'added'} successfully`);
                    resetForm();
                    loadUsers();
                } else {
                    debug(`${isEditing ? 'Update' : 'Add'} error: ${result.error}`);
                    alert(`Error ${isEditing ? 'updating' : 'adding'} user: ` + result.error);
                }
            } catch (error) {
                debug(`${isEditing ? 'Update' : 'Add'} fetch error: ${error.message}`);
                alert('Network error: ' + error.message);
            }
        });

        // Load users when page loads
        document.addEventListener('DOMContentLoaded', function() {
            debug('Page loaded, initializing...');
            loadUsers();
        });
    </script>
</body>
</html>
