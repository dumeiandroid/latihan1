<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Hitung Cepat (Latihan)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css"> </head>
<body>

    <header class="bg-primary text-white py-3">
        <div class="container d-flex justify-content-between align-items-center">
            <h1>Aplikasi Hitung Cepat</h1>
            <nav>
                <span id="welcomeMessage" class="me-3"></span>
                <a href="ranking.html" class="btn btn-light btn-sm me-2">Lihat Ranking Global</a>
                <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
            </nav>
        </div>
    </header>

    <main class="container my-5">
        <section id="calculation-app" class="bg-light p-4 rounded mb-5">
            <h3 class="mb-4">Latihan Penjumlahan</h3>
            <form id="calculationForm">
                <div class="mb-3">
                    <label for="number1" class="form-label">Angka Pertama:</label>
                    <input type="number" class="form-control" id="number1" required>
                </div>
                <div class="mb-3">
                    <label for="number2" class="form-label">Angka Kedua:</label>
                    <input type="number" class="form-control" id="number2" required>
                </div>
                
                <button type="submit" class="btn btn-primary">Hitung & Simpan Skor</button>
                <div id="calculationResult" class="mt-3 fs-4 fw-bold"></div>
                <div id="formMessage" class="mt-3"></div>
            </form>
        </section>

        <section id="user-stats" class="mt-5 bg-info bg-opacity-10 p-4 rounded">
            <h3>Statistik Anda</h3>
            <p><strong>Highest Score Penjumlahan:</strong> <span id="highestSumScore">0</span></p>
            <p><strong>Jumlah Latihan Penjumlahan:</strong> <span id="totalSumCalcs">0</span></p>
            <p><strong>Terakhir Latihan Penjumlahan:</strong> <span id="lastSumCalcTime">N/A</span></p>
            <button class="btn btn-secondary btn-sm mt-3" onclick="loadUserStats()">Refresh Statistik</button>
        </section>
    </main>

    <footer class="bg-dark text-white text-center py-3">
        <p>&copy; 2024 Aplikasi Hitung Cepat. Hak Cipta Dilindungi.</p>
    </footer>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcOdihgSs1wWcBUrP+jF7azBuL" crossorigin="anonymous"></script>
    <script>
        const API_BASE_URL = '/api'; 
        const CONTACTS_API_URL = `${API_BASE_URL}/contacts`; 
        const USERS_TABLE_NAME = 'users';

        let currentUser = null; // Variabel untuk menyimpan data user yang sedang login

        // Fungsi untuk memeriksa status login dan mengarahkan jika belum login
        function checkLogin() {
            const loggedInUserStr = localStorage.getItem('loggedInUser');
            if (loggedInUserStr) {
                currentUser = JSON.parse(loggedInUserStr);
                $('#welcomeMessage').text(`Halo, ${currentUser.username}!`);
                loadUserStats(); // Muat statistik user setelah login
            } else {
                window.location.href = 'index.html'; // Arahkan ke halaman login jika belum login
            }
        }

        // Fungsi untuk memuat statistik spesifik user dari kolom x_04
        function loadUserStats() {
            if (!currentUser) return; // Pastikan ada user yang login

            // ---- AWAS! Bagian ini juga kurang efisien untuk produksi ----
            // Mengambil SEMUA data user, lalu mencari dan mengolah di frontend
            $.get(`${CONTACTS_API_URL}?table=${USERS_TABLE_NAME}`)
                .done(function(response) {
                    if (response.success && response.data) {
                        const users = response.data;
                        // Cari profil user yang sedang login
                        const userProfile = users.find(user => user.id_x === currentUser.id);

                        if (userProfile && userProfile.x_04) {
                            try {
                                // Parsing data JSON dari kolom x_04
                                const scoreData = JSON.parse(userProfile.x_04);
                                $('#highestSumScore').text(scoreData.highest_score_sum || 0);
                                $('#totalSumCalcs').text(scoreData.total_calculations_sum || 0);
                                $('#lastSumCalcTime').text(scoreData.last_calc_sum_time ? new Date(scoreData.last_calc_sum_time).toLocaleString() : 'N/A');
                            } catch (e) {
                                console.warn('JSON tidak valid di x_04 untuk pengguna saat ini:', e);
                                alert('Data statistik pengguna tidak valid atau rusak.');
                            }
                        } else {
                            // Reset tampilan jika tidak ada data skor
                            $('#highestSumScore').text(0);
                            $('#totalSumCalcs').text(0);
                            $('#lastSumCalcTime').text('N/A');
                        }
                    }
                })
                .fail(function(jqXHR) {
                    console.error('Error memuat statistik user:', jqXHR.responseText);
                    alert('Gagal memuat statistik pengguna.');
                });
            // -----------------------------------------------------------
        }

        $(document).ready(function() {
            checkLogin(); // Panggil fungsi cek login saat halaman app.html dimuat

            // Tombol Logout
            $('#logoutBtn').click(function() {
                localStorage.removeItem('loggedInUser'); // Hapus info login dari localStorage
                window.location.href = 'index.html'; // Arahkan kembali ke halaman login
            });

            // Form Perhitungan
            $('#calculationForm').on('submit', function(e) {
                e.preventDefault(); 
                if (!currentUser) { // Pastikan user sudah login sebelum menyimpan skor
                    alert('Anda harus login untuk menyimpan skor.');
                    return;
                }

                const form = $(this);
                const messageDiv = $('#formMessage');
                const resultDiv = $('#calculationResult');
                
                messageDiv.empty().removeClass('alert alert-success alert-danger');
                resultDiv.empty();

                const num1 = parseFloat($('#number1').val());
                const num2 = parseFloat($('#number2').val());

                if (isNaN(num1) || isNaN(num2)) {
                    messageDiv.text('Harap masukkan kedua angka yang valid.').addClass('alert alert-danger');
                    return;
                }
                
                const result = num1 + num2; // Lakukan perhitungan penjumlahan
                
                // ---- Logika update skor di frontend ----
                // Ambil data user saat ini (lagi-lagi, tidak efisien tapi sesuai permintaan tanpa backend baru)
                $.get(`${CONTACTS_API_URL}?table=${USERS_TABLE_NAME}`)
                    .done(function(response) {
                        if (response.success && response.data) {
                            const users = response.data;
                            // Temukan user yang sedang login di data yang diambil
                            let userToUpdate = users.find(user => user.id_x === currentUser.id);

                            if (!userToUpdate) {
                                alert('Pengguna tidak ditemukan untuk update skor.');
                                return;
                            }

                            let currentScoreData = {};
                            // Coba parsing JSON dari x_04, jika ada dan valid
                            if (userToUpdate.x_04) {
                                try {
                                    currentScoreData = JSON.parse(userToUpdate.x_04);
                                } catch (e) {
                                    console.warn('JSON tidak valid di x_04 untuk user:', currentUser.id, e);
                                    currentScoreData = {}; // Reset jika JSON rusak
                                }
                            }

                            const operationType = 'sum'; // Untuk saat ini hanya penjumlahan
                            const scoreKey = `highest_score_${operationType}`; // Kunci untuk skor tertinggi
                            const timeKey = `last_calc_${operationType}_time`; // Kunci untuk waktu kalkulasi terakhir
                            const countKey = `total_calculations_${operationType}`; // Kunci untuk total kalkulasi

                            // Update skor tertinggi jika hasil saat ini lebih tinggi
                            if (!currentScoreData[scoreKey] || result > currentScoreData[scoreKey]) {
                                currentScoreData[scoreKey] = result;
                            }
                            currentScoreData[timeKey] = new Date().toISOString(); // Update waktu terakhir
                            currentScoreData[countKey] = (currentScoreData[countKey] || 0) + 1; // Tambah jumlah kalkulasi

                            // Kirim update ke backend menggunakan metode PUT pada ID user
                            $.ajax({
                                url: `${CONTACTS_API_URL}/${currentUser.id}?table=${USERS_TABLE_NAME}`,
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                data: JSON.stringify({
                                    x_04: JSON.stringify(currentScoreData) // Kirim kembali objek skor sebagai string JSON
                                    // Kolom lain (x_01, x_02, x_03) tidak perlu dikirim kecuali jika ingin diupdate
                                }),
                                success: function(updateResponse) {
                                    if (updateResponse.success) {
                                        messageDiv.text('Perhitungan berhasil disimpan!').addClass('alert alert-success');
                                        resultDiv.text('Hasil: ' + result); 
                                        form[0].reset(); // Reset form
                                        loadUserStats(); // Muat ulang statistik user setelah menyimpan
                                    } else {
                                        messageDiv.text('Gagal menyimpan perhitungan: ' + (updateResponse.message || 'Terjadi kesalahan.')).addClass('alert alert-danger');
                                    }
                                },
                                error: function(jqXHR) {
                                    let errorMessage = 'Terjadi kesalahan saat mengirim update perhitungan.';
                                    try {
                                        const errorResponse = JSON.parse(jqXHR.responseText);
                                        errorMessage = errorResponse.message || errorMessage;
                                    } catch (e) { /* ignore */ }
                                    console.error('AJAX Error (update user data):', jqXHR.responseText);
                                    messageDiv.text(errorMessage).addClass('alert alert-danger');
                                }
                            });
                        } else {
                            messageDiv.text('Gagal memuat data pengguna untuk update skor.').addClass('alert alert-danger');
                        }
                    })
                    .fail(function(jqXHR) {
                        let errorMessage = 'Terjadi kesalahan saat mengambil data pengguna untuk update skor.';
                        try {
                            const errorResponse = JSON.parse(jqXHR.responseText);
                            errorMessage = errorResponse.message || errorMessage;
                        } catch (e) { /* ignore */ }
                        console.error('AJAX Error (initial GET for update):', jqXHR.responseText);
                        messageDiv.text(errorMessage).addClass('alert alert-danger');
                    });
                // ------------------------------------------
            });
        });
    </script>
</body>
</html>