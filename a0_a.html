<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluasi Bab 1: Apa Itu Kecerdasan Emosional?</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .container {
            max-width: 900px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        h1, h3, h4 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2.5rem;
        }
        h3 {
            font-size: 1.75rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h4 {
            font-size: 1.5rem;
            margin-top: 30px;
        }
        p {
            color: #555;
            margin-bottom: 15px;
        }
        .text-muted-custom {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .api-status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #e0f2f7; /* Light blue */
            border: 1px solid #b3e5fc; /* Darker blue */
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            z-index: 1000;
            display: none; /* Hidden by default, shown by JS */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .alert-container {
            margin-top: 20px;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            padding: 15px 20px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .form-check-label {
            margin-left: 5px;
            cursor: pointer;
            color: #495057;
        }
        .form-check-input {
            cursor: pointer;
        }
        .form-control {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
            transform: translateY(-2px);
        }
        .btn-outline-secondary {
            border-radius: 8px;
            font-weight: 600;
        }
        .table {
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        .table th, .table td {
            padding: 12px 15px;
            vertical-align: middle;
        }
        .table thead th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 600;
        }
        .table tbody tr:nth-of-type(even) {
            background-color: #f8f9fa;
        }
        .badge-score {
            font-size: 1.1rem;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            display: inline-block;
        }
        .badge-success { background-color: #28a745; color: white; }
        .badge-info { background-color: #17a2b8; color: white; }
        .badge-warning { background-color: #ffc107; color: #333; }
        .badge-danger { background-color: #dc3545; color: white; }
        .progress {
            height: 25px;
            border-radius: 12px;
            margin-top: 15px;
            background-color: #e9ecef;
        }
        .progress-bar {
            border-radius: 12px;
            background-color: #007bff;
            transition: width 0.6s ease-in-out;
        }
        #saveStatus {
            margin-top: 20px;
            padding: 10px 15px;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            display: none;
        }
        /* Responsiveness */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            .container {
                padding: 20px;
            }
            .api-status-indicator {
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="apiStatus" class="api-status-indicator">
        Connecting...
    </div>

    <div class="container">
        <div id="alertContainer" class="alert-container"></div>

        <div class="text-center mb-4">
            <h1>Evaluasi Bab 1: Apa Itu Kecerdasan Emosional?</h1>
            <p class="lead text-muted-custom">Kenali dan Kembangkan Kecerdasan Emosionalmu</p>
            <p class="text-muted-custom">Membangun EQ untuk Masa Depan</p>
        </div>

        <div id="resultsSection" style="display: none;">
            <h3 class="text-center">Hasil Evaluasi Kecerdasan Emosional</h3>
            <div class="card p-3 mb-4">
                <div class="row align-items-center text-center">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <h2 id="totalScore" class="display-4 text-primary">0</h2>
                        <p id="totalLabel" class="text-muted-custom">dari 100 poin</p>
                    </div>
                    <div class="col-md-4 mb-3 mb-md-0">
                        <h2 id="percentage" class="display-4 text-success">0%</h2>
                        <p class="text-muted-custom">Pencapaian</p>
                    </div>
                    <div class="col-md-4">
                        <div id="categoryBadge" class="badge badge-score bg-secondary">Menghitung...</div>
                    </div>
                </div>
            </div>

            <p class="text-center">Progress: <span id="progressText">0%</span></p>
            <div class="progress" role="progressbar" aria-label="Progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>

            <div id="saveStatus">
                <small>Hasil telah disimpan ke database</small>
            </div>

            <h4 class="mt-5">Detail Skor per Aspek Kecerdasan Emosional</h4>
            <div id="categoryDetails" class="table-responsive">
                </div>

            <div class="text-center mt-4">
                <button onclick="resetEvaluation()" class="btn btn-outline-secondary">Evaluasi Ulang</button>
            </div>
        </div>

        <div id="formSection">
            <form id="evaluationForm">
                </form>
        </div>

        <div class="text-center mt-5">
            <p class="text-muted-custom"><em>Evaluasi ini membantu kamu mengukur pemahaman dan penerapan konsep kecerdasan emosional dalam kehidupan sehari-hari</em></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // Configuration
        const CONFIG = {
            API_BASE_URL: '/api/contacts',
            TABLE_NAME: 'evaluasi_eq',
            HEADERS: {
                'Content-Type': 'application/json',
                'X-Table-Name': 'evaluasi_eq'
            }
        };

        // Evaluation questions configuration
        const SOAL_EVALUASI = [
            {
                id: 'kesadaran_diri',
                pertanyaan: 'Apakah kamu sudah melakukan latihan kesadaran diri dengan mengenali emosi yang sedang kamu rasakan setiap hari?',
                kategori: 'Kesadaran Diri (Self-Awareness)',
                bobot: 15,
                pilihan: [
                    { value: 0, text: 'Belum pernah melakukan latihan kesadaran diri' },
                    { value: 5, text: 'Kadang-kadang mengenali emosi yang dirasakan' },
                    { value: 10, text: 'Sering melakukan refleksi emosi harian' },
                    { value: 15, text: 'Selalu mengenali dan memahami emosi yang dirasakan' }
                ]
            },
            {
                id: 'pengaturan_diri',
                pertanyaan: 'Apakah kamu sudah menerapkan teknik pengaturan diri seperti mengambil napas dalam ketika merasa frustrasi atau marah?',
                kategori: 'Pengaturan Diri (Self-Regulation)',
                bobot: 20,
                pilihan: [
                    { value: 0, text: 'Belum menerapkan teknik pengaturan diri' },
                    { value: 8, text: 'Kadang-kadang berhasil mengendalikan emosi' },
                    { value: 15, text: 'Sering berhasil mengelola emosi dengan baik' },
                    { value: 20, text: 'Selalu berhasil mengendalikan emosi secara konstruktif' }
                ]
            },
            {
                id: 'empati_praktek',
                pertanyaan: 'Apakah kamu sudah berlatih empati dengan mendengarkan dan memahami perasaan teman atau keluarga ketika mereka bercerita?',
                kategori: 'Empati (Empathy)',
                bobot: 15,
                pilihan: [
                    { value: 0, text: 'Belum berlatih empati secara sadar' },
                    { value: 5, text: 'Kadang-kadang berusaha memahami perasaan orang lain' },
                    { value: 10, text: 'Sering berlatih mendengarkan dengan empati' },
                    { value: 15, text: 'Selalu berusaha memahami dan merasakan perasaan orang lain' }
                ]
            },
            {
                id: 'keterampilan_sosial',
                pertanyaan: 'Apakah kamu sudah menerapkan keterampilan sosial dengan berkomunikasi efektif dan menyelesaikan konflik dengan cara yang konstruktif?',
                kategori: 'Keterampilan Sosial (Social Skills)',
                bobot: 20,
                pilihan: [
                    { value: 0, text: 'Belum menerapkan keterampilan sosial yang baik' },
                    { value: 8, text: 'Kadang-kadang berkomunikasi dengan baik' },
                    { value: 15, text: 'Sering berhasil berkomunikasi dan menyelesaikan konflik' },
                    { value: 20, text: 'Selalu berkomunikasi efektif dan menyelesaikan konflik dengan bijak' }
                ]
            },
            {
                id: 'journaling_refleksi',
                pertanyaan: 'Berapa kali dalam seminggu kamu melakukan journaling atau refleksi tertulis tentang emosi yang kamu rasakan?',
                kategori: 'Latihan Pengembangan EQ',
                bobot: 21,
                tipe: 'number',
                max: 7,
                multiplier: 3,
                placeholder: 'Jumlah hari per minggu (maksimal 7)',
                keterangan: '3 poin per hari, maksimal 7 hari (21 poin)'
            },
            {
                id: 'penilaian_diri',
                pertanyaan: 'Apakah kamu sudah melakukan penilaian diri dengan menjawab pertanyaan refleksi seperti yang dijelaskan dalam materi?',
                kategori: 'Penilaian Diri',
                bobot: 9,
                pilihan: [
                    { value: 0, text: 'Belum melakukan penilaian diri' },
                    { value: 3, text: 'Sudah menjawab beberapa pertanyaan refleksi' },
                    { value: 6, text: 'Sudah menjawab sebagian besar pertanyaan refleksi' },
                    { value: 9, text: 'Sudah melakukan penilaian diri secara lengkap dan jujur' }
                ]
            }
        ];

        // Category rating configuration
        const KATEGORI_RATING = [
            { min: 90, text: 'Sangat Baik',  badgeClass: 'badge-success' },
            { min: 75, text: 'Baik', badgeClass: 'badge-info' },
            { min: 60, text: 'Cukup', badgeClass: 'badge-warning' },
            { min: 40, text: 'Perlu Perbaikan', badgeClass: 'badge-danger' },
            { min: 0, text: 'Sangat Perlu Perbaikan', badgeClass: 'badge-danger' }
        ];

        // Calculate total maximum points
        const TOTAL_POIN_MAKSIMAL = SOAL_EVALUASI.reduce((total, soal) => total + soal.bobot, 0);

        // API helper functions
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: CONFIG.HEADERS,
                ...options
            };

            try {
                showApiStatus('Menghubungi server...');
                const response = await fetch(url, defaultOptions);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                showApiStatus('Berhasil terhubung');
                return data;
            } catch (error) {
                showApiStatus('Gagal terhubung: ' + error.message);
                throw error;
            }
        }

        async function saveEvaluation(data) {
            const url = `${CONFIG.API_BASE_URL}?table=${CONFIG.TABLE_NAME}`;
            return await apiRequest(url, {
                method: 'POST',
                body: JSON.stringify(data)
            });
        }

        // UI helper functions
        function showApiStatus(message) {
            const statusEl = document.getElementById('apiStatus');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
                statusEl.textContent = '';
            }, 3000);
        }

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        }

        // Question generation functions
        function generateQuestions() {
            const form = document.getElementById('evaluationForm');
            let currentCategory = '';
            let questionNumber = 1;
            let questionsHTML = '';

            SOAL_EVALUASI.forEach(soal => {
                // Add category header if different
                if (currentCategory !== soal.kategori) {
                    currentCategory = soal.kategori;
                    questionsHTML += `<h3 class="mt-4">${currentCategory}</h3>`;
                }

                // Add question
                questionsHTML += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">${questionNumber}. ${soal.pertanyaan} <span class="badge bg-info">${soal.bobot} poin</span></h5>
                            ${generateQuestionInput(soal)}
                        </div>
                    </div>
                `;

                questionNumber++;
            });

            // Add submit button
            questionsHTML += `
                <div class="text-center mt-4 mb-5">
                    <button type="submit" class="btn btn-primary btn-lg">Lihat Hasil Evaluasi</button>
                </div>
            `;

            form.innerHTML = questionsHTML;
        }

        function generateQuestionInput(soal) {
            if (soal.tipe === 'number') {
                return `
                    <div class="mb-3">
                        <input type="number"
                               class="form-control"
                               name="${soal.id}"
                               min="0"
                               max="${soal.max || ''}"
                               placeholder="${soal.placeholder || 'Masukkan nilai'}">
                        ${soal.keterangan ? `<small class="form-text text-muted">${soal.keterangan}</small>` : ''}
                    </div>
                `;
            } else {
                // Radio buttons
                let radioHTML = '<div class="form-group">';
                soal.pilihan.forEach((pilihan, index) => {
                    radioHTML += `
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="radio"
                                   name="${soal.id}"
                                   id="${soal.id}_${index}"
                                   value="${pilihan.value}" required>
                            <label class="form-check-label" for="${soal.id}_${index}">
                                ${pilihan.text} <span class="text-muted-custom">(${pilihan.value} poin)</span>
                            </label>
                        </div>
                    `;
                });
                radioHTML += '</div>';
                return radioHTML;
            }
        }

        // Calculation functions
        function calculateScore(formData) {
            let totalScore = 0;
            const detailScore = {};
            const categoryGroups = {};

            SOAL_EVALUASI.forEach(soal => {
                let score = 0;
                const value = formData.get(soal.id);

                if (value !== null && value !== '') {
                    if (soal.tipe === 'number') {
                        const numValue = Math.min(parseInt(value) || 0, soal.max || Infinity);
                        score = Math.min(numValue * (soal.multiplier || 1), soal.bobot);
                    } else {
                        score = parseInt(value) || 0;
                    }
                }

                detailScore[soal.id] = score;
                totalScore += score;

                // Group by category
                if (!categoryGroups[soal.kategori]) {
                    categoryGroups[soal.kategori] = { total: 0, score: 0 };
                }
                categoryGroups[soal.kategori].total += soal.bobot;
                categoryGroups[soal.kategori].score += score;
            });

            const percentage = Math.round((totalScore / TOTAL_POIN_MAKSIMAL) * 100 * 10) / 10;
            const category = getCategory(percentage);

            return {
                totalScore,
                totalPoinMaksimal: TOTAL_POIN_MAKSIMAL,
                detailScore,
                categoryGroups,
                percentage,
                category
            };
        }

        function getCategory(percentage) {
            for (const cat of KATEGORI_RATING) {
                if (percentage >= cat.min) {
                    return cat;
                }
            }
            return KATEGORI_RATING[KATEGORI_RATING.length - 1];
        }

        // Display functions
        function displayResults(results) {
            // Update main results
            document.getElementById('totalScore').textContent = results.totalScore;
            document.getElementById('totalLabel').textContent = `dari ${results.totalPoinMaksimal} poin`;
            document.getElementById('percentage').textContent = `${results.percentage}%`;
            
            const categoryBadge = document.getElementById('categoryBadge');
            categoryBadge.textContent = results.category.text;
            // Remove previous badge classes and add the new one
            KATEGORI_RATING.forEach(cat => categoryBadge.classList.remove(cat.badgeClass));
            categoryBadge.classList.add(results.category.badgeClass);

            document.getElementById('progressText').textContent = `${results.percentage}%`;
            document.getElementById('progressBar').style.width = `${results.percentage}%`;
            document.getElementById('progressBar').setAttribute('aria-valuenow', results.percentage);


            // Update category details
            const categoryDetails = document.getElementById('categoryDetails');
            let categoryHTML = `
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Kategori</th>
                            <th>Skor</th>
                            <th>Persentase</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.entries(results.categoryGroups).forEach(([name, data]) => {
                const categoryPercentage = data.total > 0 ? Math.round((data.score / data.total) * 100) : 0;
                categoryHTML += `
                    <tr>
                        <td>${name}</td>
                        <td>${data.score}/${data.total}</td>
                        <td>${categoryPercentage}%</td>
                    </tr>
                `;
            });
            categoryHTML += '</tbody></table>';
            categoryDetails.innerHTML = categoryHTML;

            // Show results, hide form
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('formSection').style.display = 'none';
        }

        // Form handling
        async function handleSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const results = calculateScore(formData);
            
            // Prepare data for API
            const apiData = {
                x_01: results.totalScore.toString(),
                x_02: results.percentage.toString(),
                x_03: results.category.text,
                x_04: JSON.stringify(results.categoryGroups),
                x_05: JSON.stringify(results.detailScore),
                x_06: new Date().toISOString(),
                x_07: navigator.userAgent,
                x_08: window.location.href
            };

            try {
                // Save to API
                const response = await saveEvaluation(apiData);
                
                // Display results
                displayResults(results);
                
                // Show save status
                document.getElementById('saveStatus').style.display = 'block';
                showAlert('Hasil evaluasi berhasil disimpan ke database!', 'success');
                
                console.log('Evaluation saved:', response);
            } catch (error) {
                console.error('Error saving evaluation:', error);
                
                // Still show results even if save fails
                displayResults(results);
                showAlert('Hasil evaluasi dihitung tetapi gagal disimpan: ' + error.message, 'danger');
            }
        }

        function resetEvaluation() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('formSection').style.display = 'block';
            document.getElementById('saveStatus').style.display = 'none';
            document.getElementById('evaluationForm').reset();
            document.getElementById('alertContainer').innerHTML = ''; // Clear alerts
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Hide results initially
            document.getElementById('resultsSection').style.display = 'none';
            // document.getElementById('apiStatus').style.display = 'none'; // Will be handled by showApiStatus function

            generateQuestions();
            
            // Add form submit handler
            document.getElementById('evaluationForm').addEventListener('submit', handleSubmit);
            
            console.log('Emotional Intelligence Evaluation System initialized');
            console.log('Total maximum points:', TOTAL_POIN_MAKSIMAL);
        });
    </script>
</body>
</html>