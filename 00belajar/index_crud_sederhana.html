<!-- 
  Ini adalah file HTML lengkap, sekarang tanpa jQuery.
  Semua logika interaksi API dan manipulasi DOM akan menggunakan JavaScript murni (native).
-->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Data CRUD</title>
    <!-- Memuat Tailwind CSS untuk styling yang mudah -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal {
            display: none;
        }
        .modal.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <!-- BAGIAN 1: Struktur HTML Halaman Utama -->
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-database mr-2"></i>Manajemen Data - <span id="tableName">data_latihan</span>
            </h1>
            <button id="addDataBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">
                <i class="fas fa-plus mr-1"></i>Tambah Data
            </button>
        </div>

        <!-- Wadah untuk tabel data -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border-collapse">
                <thead class="bg-gray-800 text-white sticky top-0">
                    <tr id="tableHeaders">
                        <!-- Header tabel akan dibuat secara dinamis di sini oleh JavaScript -->
                    </tr>
                </thead>
                <tbody id="dataTable">
                    <!-- Pesan loading awal -->
                    <tr>
                        <td colspan="22" class="text-center text-gray-500 py-10">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Memuat data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- BAGIAN 2: Modal untuk Tambah Data -->
    <div id="addModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold">Tambah Data</h3>
                <button onclick="closeModal('addModal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="addForm" onsubmit="event.preventDefault(); saveData();">
                <div id="addFormFields" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Form input akan dibuat di sini oleh JavaScript -->
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" onclick="closeModal('addModal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- BAGIAN 3: Modal untuk Edit Data -->
    <div id="editModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold">Edit Data</h3>
                <button onclick="closeModal('editModal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="editForm" onsubmit="event.preventDefault(); updateData();">
                <input type="hidden" id="editId">
                <div id="editFormFields" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Form input akan dibuat di sini oleh JavaScript -->
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" onclick="closeModal('editModal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Update</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Bagian untuk menampilkan pesan notifikasi -->
    <div id="alertContainer" class="fixed top-4 right-4 z-[9999]"></div>

    <!-- BAGIAN 4: Kode JavaScript untuk Logika CRUD -->
    <script>
        // --- Konfigurasi dan Variabel ---
        let currentTable = 'data_latihan';
        const numXFields = 20;
        let tableHeaders = [];
        const apiBaseUrl = 'https://lidan-co-id.pages.dev/api/contacts_filter_dinamis';

        // --- Fungsi Pembantu untuk Modal dan Alert ---
        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }
        
        function showConfirmation(message, onConfirm) {
            if (window.confirm(message)) {
                onConfirm();
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertHtml = `
                <div class="relative px-4 py-3 rounded-lg shadow-md mb-2
                    ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    <span>${message}</span>
                </div>
            `;
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            setTimeout(() => {
                const firstAlert = alertContainer.querySelector('div');
                if (firstAlert) {
                    firstAlert.remove();
                }
            }, 3000);
        }
        
        // --- Fungsi untuk Mengatur Tampilan Awal ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentTable = urlParams.get('tabel') || 'data_latihan';
            document.getElementById('tableName').textContent = currentTable;
            
            document.getElementById('addDataBtn').addEventListener('click', () => {
                document.getElementById('addForm').reset();
                openModal('addModal');
            });
            
            generateFormFields('addFormFields');
            generateFormFields('editFormFields');
            
            loadData();
        });

        // --- Fungsi Pembantu untuk Membuat Form Input Dinamis ---
        function generateFormFields(containerId) {
            const container = document.getElementById(containerId);
            let fieldsHtml = '';
            for (let i = 1; i <= numXFields; i++) {
                const x_name = `x_${i < 10 ? '0' : ''}${i}`;
                fieldsHtml += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">${x_name}</label>
                        <input type="text" name="${x_name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                `;
            }
            container.innerHTML = fieldsHtml;
        }

        // --- Fungsi-fungsi CRUD dengan Fetch API ---

        // Fungsi (R)ead: Mengambil dan menampilkan data
        async function loadData() {
            const dataTable = document.getElementById('dataTable');
            dataTable.innerHTML = `<tr><td colspan="22" class="text-center py-4 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data...</td></tr>`;

            try {
                const response = await fetch(`${apiBaseUrl}?table=${currentTable}`, {
                    method: 'GET',
                    headers: {'X-Table-Name': currentTable}
                });
                const responseData = await response.json();
                
                if (responseData.data && responseData.data.length > 0) {
                    tableHeaders = Object.keys(responseData.data[0]);
                    renderTableHeaders(tableHeaders);
                    renderTableBody(responseData.data);
                } else {
                    dataTable.innerHTML = `<tr><td colspan="22" class="text-center py-4 text-gray-500">Tidak ada data ditemukan.</td></tr>`;
                }

            } catch (error) {
                console.error('Error memuat data:', error);
                dataTable.innerHTML = `<tr><td colspan="22" class="text-center py-4 text-red-500">Error memuat data!</td></tr>`;
            }
        }
        
        // Fungsi pembantu untuk membuat header tabel secara dinamis
        function renderTableHeaders(headers) {
            const tableHeadersElement = document.getElementById('tableHeaders');
            let headerHtml = '';
            headers.forEach(header => {
                headerHtml += `<th class="p-4 text-left border-b border-gray-300">${header.toUpperCase()}</th>`;
            });
            headerHtml += `<th class="p-4 text-left border-b border-gray-300">AKSI</th>`;
            tableHeadersElement.innerHTML = headerHtml;
        }

        // Fungsi pembantu untuk membuat isi tabel secara dinamis
        function renderTableBody(data) {
            const dataTable = document.getElementById('dataTable');
            let html = '';
            data.forEach(item => {
                html += `<tr class="border-b">`;
                tableHeaders.forEach(header => {
                    html += `<td class="p-4">${item[header] || ''}</td>`;
                });
                html += `<td class="p-4">
                            <button class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition" onclick="editData(${item.id_x})"><i class="fas fa-edit"></i></button>
                            <button class="bg-red-500 text-white px-3 py-1 rounded-lg ml-1 hover:bg-red-600 transition" onclick="deleteData(${item.id_x})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
            dataTable.innerHTML = html;
        }

        // Fungsi (C)reate: Menambah data baru
        async function saveData() {
            const formData = {};
            const formInputs = document.querySelectorAll('#addForm input[type="text"]');
            formInputs.forEach(input => {
                formData[input.name] = input.value;
            });

            try {
                const response = await fetch(`${apiBaseUrl}?table=${currentTable}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Table-Name': currentTable
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    closeModal('addModal');
                    document.getElementById('addForm').reset();
                    loadData();
                    showAlert('Data berhasil ditambahkan!', 'success');
                } else {
                    showAlert('Error menambah data!', 'danger');
                }
            } catch (error) {
                console.error('Error menambah data:', error);
                showAlert('Error menambah data!', 'danger');
            }
        }

        // Fungsi untuk mengambil data spesifik (digunakan untuk edit)
        async function editData(id) {
            try {
                const response = await fetch(`${apiBaseUrl}/${id}?table=${currentTable}`, {
                    method: 'GET',
                    headers: {'X-Table-Name': currentTable}
                });
                const responseData = await response.json();
                
                if (response.ok && responseData.data) {
                    document.getElementById('editId').value = responseData.data.id_x;
                    for(let i = 1; i <= numXFields; i++) {
                        const x_name = `x_${i < 10 ? '0' : ''}${i}`;
                        const inputElement = document.querySelector(`#editForm input[name="${x_name}"]`);
                        if (inputElement) {
                            inputElement.value = responseData.data[x_name] || '';
                        }
                    }
                    openModal('editModal');
                } else {
                    showAlert('Error memuat data!', 'danger');
                }
            } catch (error) {
                console.error('Error memuat data:', error);
                showAlert('Error memuat data!', 'danger');
            }
        }

        // Fungsi (U)pdate: Mengupdate data
        async function updateData() {
            const id = document.getElementById('editId').value;
            const formData = {};
            const formInputs = document.querySelectorAll('#editForm input[type="text"]');
            formInputs.forEach(input => {
                formData[input.name] = input.value;
            });

            try {
                const response = await fetch(`${apiBaseUrl}/${id}?table=${currentTable}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Table-Name': currentTable
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    closeModal('editModal');
                    loadData();
                    showAlert('Data berhasil diupdate!', 'success');
                } else {
                    showAlert('Error update data!', 'danger');
                }
            } catch (error) {
                console.error('Error update data:', error);
                showAlert('Error update data!', 'danger');
            }
        }
        
        // Fungsi (D)elete: Menghapus data
        async function deleteData(id) {
            showConfirmation('Yakin ingin menghapus data ini?', async () => {
                try {
                    const response = await fetch(`${apiBaseUrl}/${id}?table=${currentTable}`, {
                        method: 'DELETE',
                        headers: {'X-Table-Name': currentTable}
                    });

                    if (response.ok) {
                        loadData();
                        showAlert('Data berhasil dihapus!', 'success');
                    } else {
                        showAlert('Error hapus data!', 'danger');
                    }
                } catch (error) {
                    console.error('Error hapus data:', error);
                    showAlert('Error hapus data!', 'danger');
                }
            });
        }
    </script>
</body>
</html>
